<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Dashboard - User Categorized Tasks</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Additional test styles */
        .test-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .test-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            margin: 0.5rem;
        }

        .test-button:hover {
            background: #2563eb;
        }
    </style>
</head>

<body>
    <div class="test-container">
        <div class="test-header">
            <h1>Dashboard Test - User Categorized Tasks</h1>
            <p>This is a test page to demonstrate the new user-categorized task display functionality.</p>
            <button class="test-button" onclick="loadTestData()">Load Test Data</button>
            <button class="test-button" onclick="clearData()">Clear Data</button>
        </div>

        <!-- Task List -->
        <div class="task-list">
            <div class="task-header">
                <h2 class="font-semibold">Tasks by Assignee</h2>
                <p class="text-gray-600 text-sm">Tasks are automatically grouped by the user they are assigned to</p>
                <div class="flex items-center gap-2">
                    <select id="sortBy" class="form-input" style="width: auto; padding: 0.5rem;" title="Sort tasks by">
                        <option value="dueDate">Sort by Due Date</option>
                        <option value="priority">Sort by Priority</option>
                        <option value="status">Sort by Status</option>
                        <option value="title">Sort by Title</option>
                    </select>
                    <button class="test-button" onclick="refreshTestData()" title="Refresh test data">
                        ðŸ”„ Refresh Test Data
                    </button>
                </div>
            </div>

            <!-- Data Source Info -->
            <div id="dataSourceInfo" class="data-source-info" style="display: none;">
                <!-- Will be populated dynamically -->
            </div>

            <!-- User Task Groups -->
            <div id="userTaskGroups" class="user-task-groups">
                <div class="p-6 text-center text-gray-500">Click "Load Test Data" to see tasks grouped by user</div>
            </div>
        </div>
    </div>

    <script>
        // Test data
        const testTasks = [
            {
                id: '1',
                title: 'Follow up with client',
                description: 'Call client to discuss project requirements',
                dueDate: '2024-01-15',
                priority: 'high',
                status: 'incomplete',
                owner: 'John Doe',
                contactId: 'contact1',
                // Opportunity context from standalone script
                opportunityTitle: 'Website Redesign Project',
                opportunityStage: 'Discovery',
                opportunityValue: 25000,
                opportunityStatus: 'Active',
                source: 'pipeline_opportunities_search',
                method: 'Searched opportunities with tasks in pipeline'
            },
            {
                id: '2',
                title: 'Review proposal',
                description: 'Review and approve the new proposal',
                dueDate: '2024-01-20',
                priority: 'medium',
                status: 'in-progress',
                owner: 'John Doe',
                contactId: 'contact2',
                opportunityTitle: 'E-commerce Platform Development',
                opportunityStage: 'Proposal',
                opportunityValue: 45000,
                opportunityStatus: 'Pending',
                source: 'pipeline_opportunities_search',
                method: 'Searched opportunities with tasks in pipeline'
            },
            {
                id: '3',
                title: 'Send invoice',
                description: 'Send invoice for completed work',
                dueDate: '2024-01-18',
                priority: 'low',
                status: 'complete',
                owner: 'Sarah Smith',
                contactId: 'contact3',
                opportunityTitle: 'Mobile App Development',
                opportunityStage: 'Completed',
                opportunityValue: 35000,
                opportunityStatus: 'Won',
                source: 'pipeline_opportunities_search',
                method: 'Searched opportunities with tasks in pipeline'
            },
            {
                id: '4',
                title: 'Update website',
                description: 'Update company website with new content',
                dueDate: '2024-01-25',
                priority: 'medium',
                status: 'incomplete',
                owner: 'Sarah Smith',
                contactId: 'contact4',
                opportunityTitle: 'Website Redesign Project',
                opportunityStage: 'Development',
                opportunityValue: 25000,
                opportunityStatus: 'Active',
                source: 'pipeline_opportunities_search',
                method: 'Searched opportunities with tasks in pipeline'
            },
            {
                id: '5',
                title: 'Team meeting',
                description: 'Weekly team status meeting',
                dueDate: '2024-01-16',
                priority: 'high',
                status: 'incomplete',
                owner: 'Admin User',
                contactId: 'contact5',
                opportunityTitle: 'E-commerce Platform Development',
                opportunityStage: 'Planning',
                opportunityValue: 45000,
                opportunityStatus: 'Active',
                source: 'pipeline_opportunities_search',
                method: 'Searched opportunities with tasks in pipeline'
            },
            {
                id: '6',
                title: 'Prepare presentation',
                description: 'Prepare slides for client presentation',
                dueDate: '2024-01-22',
                priority: 'high',
                status: 'in-progress',
                owner: 'Admin User',
                contactId: 'contact6',
                opportunityTitle: 'Website Redesign Project',
                opportunityStage: 'Discovery',
                opportunityValue: 25000,
                opportunityStatus: 'Active',
                source: 'pipeline_opportunities_search',
                method: 'Searched opportunities with tasks in pipeline'
            }
        ];

        const testContacts = [
            { id: 'contact1', name: 'Client A', email: 'clienta@example.com' },
            { id: 'contact2', name: 'Client B', email: 'clientb@example.com' },
            { id: 'contact3', name: 'Client C', email: 'clientc@example.com' },
            { id: 'contact4', name: 'Client D', email: 'clientd@example.com' },
            { id: 'contact5', name: 'Client E', email: 'cliente@example.com' },
            { id: 'contact6', name: 'Client F', email: 'clientf@example.com' }
        ];

        // Global variables for test
        let tasks = [];
        let contacts = [];
        let currentFilter = 'all';
        let currentSort = 'dueDate';

        function loadTestData() {
            tasks = [...testTasks];
            contacts = [...testContacts];
            renderTasks();
        }

        function clearData() {
            tasks = [];
            contacts = [];
            renderTasks();
        }

        function filterTasks() {
            return tasks.filter(task => {
                switch (currentFilter) {
                    case 'my':
                        return task.owner === 'Admin User'; // Simulate current user
                    case 'team':
                        return task.owner !== 'Admin User';
                    case 'overdue':
                        return new Date(task.dueDate) < new Date() && task.status !== 'complete';
                    default:
                        return true;
                }
            });
        }

        function sortTasks(tasks) {
            return tasks.sort((a, b) => {
                switch (currentSort) {
                    case 'priority':
                        const priorityOrder = { 'high': 3, 'medium': 2, 'low': 1 };
                        return priorityOrder[b.priority] - priorityOrder[a.priority];
                    case 'status':
                        const statusOrder = { 'incomplete': 3, 'in-progress': 2, 'complete': 1 };
                        return statusOrder[b.status] - statusOrder[a.status];
                    case 'title':
                        return a.title.localeCompare(b.title);
                    default: // dueDate
                        return new Date(a.dueDate) - new Date(b.dueDate);
                }
            });
        }

        function createTaskHTML(task) {
            const isOverdue = new Date(task.dueDate) < new Date() && task.status !== 'complete';
            const priorityClass = `priority-${task.priority}`;
            const statusClass = `status-${task.status}`;

            // Find contact information
            const contact = contacts.find(c => c.id === task.contactId);
            const contactName = contact ? contact.name || contact.email : 'Unknown Contact';

            // Build opportunity context HTML if available (for demonstration)
            let opportunityContext = '';
            if (task.opportunityTitle || task.opportunityStage || task.opportunityValue) {
                opportunityContext = `
                           <div class="opportunity-context">
                               <div class="opportunity-header">
                                   <span class="opportunity-icon">ðŸŽ¯</span>
                                   <span class="opportunity-title">${task.opportunityTitle || 'Untitled Opportunity'}</span>
                               </div>
                               <div class="opportunity-details">
                                   ${task.opportunityStage ? `<span class="stage-badge">${task.opportunityStage}</span>` : ''}
                                   ${task.opportunityValue ? `<span class="value-badge">$${task.opportunityValue.toLocaleString()}</span>` : ''}
                                   ${task.opportunityStatus ? `<span class="status-badge">${task.opportunityStatus}</span>` : ''}
                               </div>
                           </div>
                       `;
            }

            return `
                       <div class="task-item ${isOverdue ? 'overdue' : ''}" data-task-id="${task.id}">
                           <input type="checkbox" class="task-checkbox" ${task.status === 'complete' ? 'checked' : ''} disabled>
                           
                           <div class="task-content">
                               <div class="task-title">${task.title}</div>
                               <div class="task-description">${task.description || 'No description'}</div>
                               
                               ${opportunityContext}
                               
                               <div class="task-meta">
                                   <span>ðŸ“ž Contact: ${contactName}</span>
                                   <span>ðŸ“… Due: ${formatDate(task.dueDate)}</span>
                                   <span>ðŸ‘¤ Owner: ${task.owner}</span>
                                   <span class="priority-badge ${priorityClass}">${task.priority.toUpperCase()}</span>
                                   <span class="status-badge ${statusClass}">${task.status.replace('-', ' ').toUpperCase()}</span>
                               </div>
                           </div>
                           
                           <div class="task-actions">
                               <button class="btn btn-secondary btn-sm" disabled>Edit</button>
                               <button class="btn btn-secondary btn-sm" disabled>Delete</button>
                           </div>
                       </div>
                   `;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function groupTasksByUser(tasks) {
            const grouped = {};

            tasks.forEach(task => {
                const owner = task.owner || 'Unassigned';
                if (!grouped[owner]) {
                    grouped[owner] = [];
                }
                grouped[owner].push(task);
            });

            return grouped;
        }

        function renderUserTaskGroups(tasksByUser) {
            let html = '';

            Object.keys(tasksByUser).forEach(userName => {
                const userTasks = tasksByUser[userName];
                const completedCount = userTasks.filter(task => task.status === 'complete').length;
                const totalCount = userTasks.length;

                html += `
                    <div class="user-task-group mb-6">
                        <div class="user-task-header">
                            <h3 class="user-name">ðŸ‘¤ ${userName}</h3>
                            <div class="user-task-stats">
                                <span class="task-count">${completedCount}/${totalCount} completed</span>
                            </div>
                        </div>
                        <div class="user-tasks">
                            ${userTasks.length > 0 ? userTasks.map(task => createTaskHTML(task)).join('') : '<div class="p-4 text-center text-gray-500">No tasks assigned</div>'}
                        </div>
                    </div>
                `;
            });

            return html;
        }

        function renderTasks() {
            const userTaskGroupsContainer = document.getElementById('userTaskGroups');
            const dataSourceInfoContainer = document.getElementById('dataSourceInfo');

            if (tasks.length === 0) {
                userTaskGroupsContainer.innerHTML = '<div class="p-6 text-center text-gray-500">No tasks found</div>';
                dataSourceInfoContainer.style.display = 'none';
                return;
            }

            // Show data source info if available
            if (tasks.length > 0 && tasks[0].source) {
                const uniqueSources = [...new Set(tasks.map(task => task.source))];
                const uniqueMethods = [...new Set(tasks.map(task => task.method))];
                const pipelineIds = [...new Set(tasks.map(task => task.pipelineId).filter(Boolean))];

                dataSourceInfoContainer.innerHTML = `
                           <h4>ðŸ“Š Data Source Information</h4>
                           <div class="data-source-details">
                               ${uniqueSources.length > 0 ? `<div class="data-source-item">
                                   <span class="data-source-label">Source:</span>
                                   <span class="data-source-value">${uniqueSources.join(', ')}</span>
                               </div>` : ''}
                               ${uniqueMethods.length > 0 ? `<div class="data-source-item">
                                   <span class="data-source-label">Method:</span>
                                   <span class="data-source-value">${uniqueMethods.join(', ')}</span>
                               </div>` : ''}
                               ${pipelineIds.length > 0 ? `<div class="data-source-item">
                                   <span class="data-source-label">Pipeline:</span>
                                   <span class="data-source-value">${pipelineIds.join(', ')}</span>
                               </div>` : ''}
                               <div class="data-source-item">
                                   <span class="data-source-label">Total Tasks:</span>
                                   <span class="data-source-value">${tasks.length}</span>
                               </div>
                           </div>
                       `;
                dataSourceInfoContainer.style.display = 'block';
            } else {
                dataSourceInfoContainer.style.display = 'none';
            }

            // Group tasks by assigned user
            const tasksByUser = groupTasksByUser(tasks);

            // Render tasks grouped by user
            userTaskGroupsContainer.innerHTML = renderUserTaskGroups(tasksByUser);
        }

        // Set up event listeners
        document.getElementById('sortBy').addEventListener('change', function () {
            currentSort = this.value;
            renderTasks();
        });
        
        // Function to refresh test data
        function refreshTestData() {
            console.log('ðŸ”„ Refreshing test data...');
            clearData();
            setTimeout(() => {
                loadTestData();
            }, 100);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Test dashboard loaded. Click "Load Test Data" to see the user-categorized task display.');
        });
    </script>
</body>

</html>